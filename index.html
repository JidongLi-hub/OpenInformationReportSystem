<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>态势感知智能分析系统 | Situation Awareness System</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #0f172a; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* 滚动条样式优化 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .cursor-blink { animation: blink 1s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        /* Markdown 排版优化 */
        .prose h1, .prose h2, .prose h3 { color: #f1f5f9; font-weight: 700; margin-top: 1.2em; margin-bottom: 0.6em; }
        .prose h1 { font-size: 1.6rem; border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; color: #60a5fa; }
        .prose h2 { font-size: 1.3rem; color: #93c5fd; display: flex; align-items: center; }
        .prose h2::before { content: ''; display: inline-block; width: 6px; height: 1.3rem; background: #3b82f6; margin-right: 0.5rem; border-radius: 2px; }
        .prose p { margin-bottom: 1em; line-height: 1.7; color: #cbd5e1; font-size: 0.95rem; }
        .prose strong { color: #38bdf8; font-weight: 600; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; color: #94a3b8; }
        .prose li { margin-bottom: 0.3em; }
        .prose blockquote { border-left: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.05); padding: 0.8rem 1rem; border-radius: 0 6px 6px 0; margin: 1rem 0; color: #94a3b8; font-style: italic; }
        .prose code { background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 4px; font-family: 'JetBrains Mono'; font-size: 0.85em; color: #f472b6; }
    </style>
</head>
<!-- 核心修复 1: 移除 overflow-hidden，改用 flex 布局控制高度，防止截断 -->
<body class="text-slate-200 antialiased h-screen w-screen overflow-hidden flex flex-col bg-slate-900">
    <div id="root" class="h-full w-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            Activity: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
            Shield: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            Send: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Database: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            FileText: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            Cpu: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><path d="M9 1v3M15 1v3M9 20v3M15 20v3M20 9h3M20 14h3M1 9h3M1 14h3"/></svg>,
            CheckCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
            Terminal: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
        };

        const Header = ({ status }) => {
            const [timeStr, setTimeStr] = useState(new Date().toLocaleTimeString());
            useEffect(() => {
                const timer = setInterval(() => setTimeStr(new Date().toLocaleTimeString()), 1000);
                return () => clearInterval(timer);
            }, []);

            return (
                <header className="glass-panel sticky top-0 z-50 h-16 shrink-0 px-6 flex justify-between items-center border-b border-slate-700/50">
                    <div className="flex items-center gap-3">
                        <div className="relative">
                            <Icons.Shield width="28" height="28" className="text-blue-500" />
                            <div className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-blue-400 rounded-full animate-pulse shadow-[0_0_10px_#60a5fa]"></div>
                        </div>
                        <div>
                            <h1 className="text-lg font-bold tracking-wider text-white">SAS-PRO <span className="text-blue-500 text-xs font-normal ml-2 opacity-80">态势感知智能分析系统</span></h1>
                        </div>
                    </div>
                    <div className="flex items-center gap-6">
                        <div className="flex items-center gap-2 text-xs font-mono text-slate-400">
                            <div className={`w-2 h-2 rounded-full ${status ? 'bg-emerald-500 shadow-[0_0_8px_#10b981]' : 'bg-red-500'}`}></div>
                            {status ? 'SYSTEM ONLINE' : 'DISCONNECTED'}
                        </div>
                        <div className="text-slate-400 text-xs font-mono w-20 text-right">{timeStr}</div>
                    </div>
                </header>
            );
        };

        const App = () => {
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const [report, setReport] = useState("");
            const [retrievedInfo, setRetrievedInfo] = useState("");
            const [systemStatus, setSystemStatus] = useState(true);
            const [displayedReport, setDisplayedReport] = useState("");
            const [activeTab, setActiveTab] = useState('report'); 
            
            // 自动滚动到底部 Ref
            const reportEndRef = useRef(null);

            useEffect(() => {
                if (!report) { setDisplayedReport(""); return; }
                let i = 0;
                const timer = setInterval(() => {
                    setDisplayedReport(report.substring(0, i));
                    i += 3; // 加快打字速度
                    if (i > report.length) clearInterval(timer);
                }, 10); 
                return () => clearInterval(timer);
            }, [report]);

            // 打字时自动滚动
            useEffect(() => {
                if(reportEndRef.current && activeTab === 'report') {
                    reportEndRef.current.scrollIntoView({ behavior: "smooth" });
                }
            }, [displayedReport, activeTab]);

            const handleSubmit = async () => {
                if (!input.trim()) return;
                setLoading(true);
                setReport("");
                setDisplayedReport("");
                setRetrievedInfo("");
                setActiveTab('report');

                try {
                    const response = await fetch("/generate_report", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ user_prompt: input })
                    });

                    if (!response.ok) throw new Error("Connection Error");
                    const data = await response.json();
                    
                    setRetrievedInfo(data.retrieved_info || "未检索到相关情报。");
                    setReport(data.report_content || "生成失败，请重试。");
                } catch (error) {
                    console.error(error);
                    setRetrievedInfo("System Error: 无法连接后端。");
                    setReport("❌ 生成失败：请检查后端服务是否启动。");
                    setSystemStatus(false);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="h-full w-full bg-[url('https://res.cloudinary.com/practicaldev/image/fetch/s--_MCEk7P6--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/1wwdyw5de8avrdkgtz5n.png')] bg-cover bg-center flex flex-col">
                    <div className="flex-1 flex flex-col bg-slate-950/90 backdrop-blur-sm overflow-hidden">
                        
                        <Header status={systemStatus} />

                        {/* 核心修复 2: min-h-0 是 Flex 嵌套滚动的关键，防止内容溢出屏幕 */}
                        <main className="flex-1 min-h-0 p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 max-w-[1920px] mx-auto w-full">
                            
                            {/* 左侧：控制台 */}
                            <div className="lg:col-span-4 flex flex-col h-full gap-4 overflow-hidden">
                                <div className="glass-panel rounded-xl flex flex-col h-full border-t-4 border-t-blue-600">
                                    <div className="p-4 border-b border-slate-700 bg-slate-800/30 flex items-center gap-2 shrink-0">
                                        <Icons.Activity width="18" className="text-blue-400"/>
                                        <span className="font-bold text-slate-200 text-sm tracking-wide">指令控制台 / COMMAND</span>
                                    </div>
                                    
                                    <div className="p-4 flex-1 flex flex-col gap-4 min-h-0">
                                        <textarea
                                            value={input}
                                            onChange={(e) => setInput(e.target.value)}
                                            placeholder="请输入指令 (例如：分析当前台海周边海域的安全态势...)"
                                            className="w-full flex-1 bg-slate-900/50 border border-slate-700 rounded-lg p-4 text-slate-300 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all resize-none font-mono text-sm leading-relaxed placeholder:text-slate-600"
                                        ></textarea>
                                        
                                        <button
                                            onClick={handleSubmit}
                                            disabled={loading}
                                            className={`w-full py-4 rounded-lg font-bold tracking-wider flex items-center justify-center gap-2 transition-all shadow-lg shrink-0 ${
                                                loading 
                                                ? 'bg-slate-800 cursor-not-allowed text-slate-500 border border-slate-700' 
                                                : 'bg-blue-600 hover:bg-blue-500 text-white shadow-blue-600/20 hover:shadow-blue-600/40'
                                            }`}
                                        >
                                            {loading ? <><Icons.Cpu width="20" className="animate-spin" /><span>研判中...</span></> : <><Icons.Send width="18" /><span>立即生成报告</span></>}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* 右侧：结果展示区 */}
                            <div className="lg:col-span-8 h-full flex flex-col gap-4 overflow-hidden">
                                <div className="glass-panel rounded-xl flex flex-col h-full border-t-4 border-t-emerald-500 relative">
                                    
                                    {/* Tab 导航栏 */}
                                    <div className="h-14 shrink-0 border-b border-slate-700 bg-slate-800/30 flex items-center justify-between px-2">
                                        <div className="flex gap-2 h-full items-end">
                                            <button onClick={() => setActiveTab('report')} className={`px-6 py-3 text-sm font-bold flex items-center gap-2 rounded-t-lg transition-all ${activeTab === 'report' ? 'bg-slate-700/50 text-emerald-400 border-t-2 border-emerald-400' : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800/50'}`}>
                                                <Icons.FileText width="16" /> 态势分析报告
                                            </button>
                                            <button onClick={() => setActiveTab('source')} className={`px-6 py-3 text-sm font-bold flex items-center gap-2 rounded-t-lg transition-all ${activeTab === 'source' ? 'bg-slate-700/50 text-blue-400 border-t-2 border-blue-400' : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800/50'}`}>
                                                <Icons.Database width="16" /> 原始情报溯源 {retrievedInfo && <span className="ml-1 bg-slate-700 text-slate-300 text-[10px] px-1.5 py-0.5 rounded-full">Source</span>}
                                            </button>
                                        </div>
                                        <div className="mr-4">
                                            {loading ? <span className="text-xs text-blue-400 animate-pulse font-mono">PROCESSING...</span> : report ? <span className="text-xs text-emerald-500 font-mono flex items-center gap-1"><Icons.CheckCircle width="14" /> READY</span> : null}
                                        </div>
                                    </div>

                                    {/* 内容区域容器 */}
                                    <div className="flex-1 min-h-0 relative bg-slate-900/20 overflow-hidden">
                                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-5 pointer-events-none">
                                            <Icons.Shield width="300" height="300" />
                                        </div>

                                        {/* 核心修复 3: 内容区域使用 absolute inset-0 确保占满且可滚动 */}
                                        
                                        {/* 视图 1: 报告 */}
                                        <div className={`absolute inset-0 overflow-y-auto p-8 transition-opacity duration-300 scroll-smooth ${activeTab === 'report' ? 'opacity-100 z-10' : 'opacity-0 -z-10'}`}>
                                            {displayedReport ? (
                                                <div className="prose prose-invert prose-slate max-w-none pb-20">
                                                    <div dangerouslySetInnerHTML={{ __html: marked.parse(displayedReport) }} />
                                                    <span className="inline-block w-2 h-5 bg-emerald-500 ml-1 align-middle cursor-blink shadow-[0_0_8px_#10b981]"></span>
                                                    {/* 底部锚点，用于自动滚动 */}
                                                    <div ref={reportEndRef}></div>
                                                </div>
                                            ) : (
                                                <div className="h-full flex flex-col items-center justify-center text-slate-600 gap-4">
                                                    <Icons.Terminal width="48" height="48" className="opacity-20" />
                                                    <p className="font-mono text-sm tracking-widest">AWAITING INPUT DATA STREAM...</p>
                                                </div>
                                            )}
                                        </div>

                                        {/* 视图 2: 溯源 */}
                                        <div className={`absolute inset-0 overflow-y-auto p-6 transition-opacity duration-300 ${activeTab === 'source' ? 'opacity-100 z-10' : 'opacity-0 -z-10'}`}>
                                            <div className="bg-black/40 rounded-lg border border-slate-700/50 p-6 min-h-full">
                                                <h3 className="text-blue-400 font-bold mb-4 flex items-center gap-2 border-b border-slate-700 pb-2">
                                                    <Icons.Database width="16"/> RAG 检索上下文数据 (Context)
                                                </h3>
                                                <div className="font-mono text-xs text-slate-400 whitespace-pre-wrap leading-relaxed">
                                                    {retrievedInfo || "// 暂无检索数据...\n// 请先发起一次分析指令。"}
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    
                                    <div className="h-8 shrink-0 border-t border-slate-800 bg-slate-900/50 flex items-center justify-between px-4 text-[10px] text-slate-600 font-mono">
                                        <span>CONFIDENTIALITY: LEVEL-3</span>
                                        <span>SERVER: 8002 / 28888</span>
                                    </div>
                                </div>
                            </div>

                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>